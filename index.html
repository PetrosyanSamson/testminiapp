<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #fff; --text: #000; --btn: #248bed; }
        body { font-family: sans-serif; background: var(--tg-theme-secondary-bg-color, #f0f2f5); color: var(--tg-theme-text-color, #000); margin: 0; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; }
        .card { background: var(--tg-theme-bg-color, #fff); border-radius: 15px; padding: 15px; margin-bottom: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card img { width: 100%; border-radius: 10px; margin-bottom: 10px; }
        
        input[type="file"] { display: none; }
        .custom-file-upload { background: var(--btn); color: white; padding: 12px; border-radius: 10px; display: block; cursor: pointer; margin: 10px 0; font-weight: bold; }
        
        button#gen-btn { width: 100%; padding: 15px; background: #31b545; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; display: none; }
        
        #status { margin-top: 15px; font-weight: bold; color: var(--btn); display: none; }
        #result-img { width: 100%; border-radius: 15px; display: none; margin-top: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--btn); border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div class="container">
    <div id="setup-step">
        <h3>1. –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω</h3>
        <div class="card" id="tpl-fine">
            <img src="https://i.ibb.co/p6XfMv0/photo-2024-03-21-12-00-00.jpg">
            <b>–®—Ç—Ä–∞—Ñ –ì–ò–ë–î–î üöî</b>
        </div>

        <h3>2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ</h3>
        <label class="custom-file-upload">
            <input type="file" id="file-input" accept="image/*">
            üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
        </label>
        <p id="file-name" style="font-size: 12px; color: gray;"></p>

        <button id="gen-btn" onclick="startGeneration()">–ù–∞—á–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é</button>
    </div>

    <div id="status-step" style="text-align: center;">
        <div id="status">
            <div class="loader"></div> <span>–ú–∞–≥–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...</span>
        </div>
        <img id="result-img">
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const BACKEND_URL = "https://interest-persian-norman-phd.trycloudflare.com"; 
    let base64Image = null;

    document.getElementById('file-input').onchange = function(e) {
        const file = e.target.files[0];
        document.getElementById('file-name').innerText = "–í—ã–±—Ä–∞–Ω–æ: " + file.name;
        document.getElementById('gen-btn').style.display = 'block';
        
        const reader = new FileReader();
        reader.onload = function() { base64Image = reader.result.split(',')[1]; };
        reader.readAsDataURL(file);
    };

    async function startGeneration() {
        document.getElementById('setup-step').style.display = 'none';
        document.getElementById('status').style.display = 'block';

        try {
            const response = await fetch(`${BACKEND_URL}/generate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    template_id: "car_fine",
                    image_base64: base64Image
                })
            });

            const data = await response.json();
            if (data.url) {
                document.getElementById('status').style.display = 'none';
                const resImg = document.getElementById('result-img');
                resImg.src = data.url;
                resImg.style.display = 'block';
                
                // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è Mini App —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => { tg.close(); }, 10000);
            } else {
                alert("–û—à–∏–±–∫–∞: " + data.error);
            }
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
            console.error(e);
        }
    }
</script>
</body>
</html>
